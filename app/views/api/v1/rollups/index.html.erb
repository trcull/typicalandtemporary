

<div id="graphs" class="graphs-div">
<% content_for :javascript_includes do %>
  <script src="https://s3.amazonaws.com/fv-assets/jqplot/jquery.jqplot.js"></script>
  <script src="https://s3.amazonaws.com/fv-assets/jqplot/plugins/jqplot.cursor.js"></script>
  <script src="https://s3.amazonaws.com/fv-assets/jqplot/plugins/jqplot.barRenderer.js"></script>
  <script src="https://s3.amazonaws.com/fv-assets/jqplot/plugins/jqplot.highlighter.js"></script>
<% end %>	
<% content_for :stylesheet_includes do %>
  <link href="https://s3.amazonaws.com/fv-assets/jqplot/jquery.jqplot.css" rel="stylesheet"></script>
<% end %>	

<div id="graph-placeholder" style="width:600p;height:600px;padding:0px;">
	
</div>
<div id="graph-controls">
	<input class="btn" type="submit" id="reset-zoom-button" value="Reset Zoom"/>
</div>

<script type="text/javascript" language="JavaScript">
(function($) { 
    $.jqplot.DecimalToPercentageFormatter = function (format, val) { 
            if (typeof val == 'number') { 
                    val = val*100; 
            if (!format) { 
                format = '%.1f'; 
            } 
            return $.jqplot.sprintf(format, val) + '%'; 
        } 
        else { 
            return String(val); 
        } 
    }; 
})(jQuery); 

//TODO: extract this into a component
draw_graph = function(div, data_series, ticks) {
    theGraph = $.jqplot(div, 
    	data_series,
    	{
    		seriesDefaults: { renderer: $.jqplot.LineRenderer
    			
    		},/*
    		legend: {
                    show: true,
                    placement: 'outsideGrid'
                }, */
    		axes: {
    			xaxis: {
    				showGridline: false,
    				renderer: $.jqplot.CategoryAxisRenderer,
    				min: 0,
    				label: "Age in days at first repurchase"
    				//ticks: ticks
    			},
    			yaxis: {
    				min: 0,
    				label: "Number of Customers",
    				tickOptions: {
    					showGridline: false
    				}
    			},
    			y2axis: {
    				min: 0,
    				label: "Percent of Customers",
    				tickOptions: {
    					showGridline: true,
    					formatter: $.jqplot.DecimalToPercentageFormatter
    				}
    			},
    			y3axis: {
    				min: 0,
    				label: "Cumulative Percent of Customers",
    				tickOptions: {
    					showGridline: false,
    					formatter: $.jqplot.DecimalToPercentageFormatter
    				}
    			}
    		},
    		series: [{yaxis:'yaxis', label:"Number", renderer: $.jqplot.LineRenderer}, //TODO: figure out why the BarRenderer looks funny and use it.
    				{yaxis:'y2axis', label: "Percent"},
    				{yaxis:'y3axis', label: "Cumulative Percent"}
    		],
    		highlighter: {
    			showTooltip: true
    		},
    		cursor: {
    			show: true,
    			zoom: true,
    			showTooltip: false
    		}
    		
  		});
};
order_counts_by_customer_age = function (div, rv) {
	var series1 = rv['num_orders'];
	var series2 = rv['pct_orders'];
	var series3 = rv['pct_cumulative'];
	var ticks = rv['customer_ages'];
	draw_graph(div, [series1,series2, series3],ticks);
};

order_count_histogram = function (div, rv) {
	var series1 = rv['num_customers'];
	var series2 = rv['pct_customers'];
	var series3 = rv['pct_cumulative'];
	var ticks = rv['num_orders'];
	draw_graph(div, [series1,series2, series3],ticks);
};

age_at_repeat_order_histogram = function (div, rv) {
	var series1 = rv['num_customers'][1];
	var series2 = rv['pct_customers'][1];
	var series3 = rv['pct_cumulative'][1];
	draw_graph(div, [series1, series2, series3],null);
};


$(document).ready(function() {
	$.jqplot.config.enablePlugins = true;
	$.ajax({
		url: "/api/v1/rollups/<%=current_user.current_organization.id%>/age_at_repeat_order_histogram",
		dataType: "json",
		error: function() {alert("Failed to fetch graph")},
		success: function(data, textStatus, jqXHR){
			age_at_repeat_order_histogram("graph-placeholder", data);
		}
	});
	$('#reset-zoom-button').click(function() {theGraph.resetZoom()});
});

</script>

</div>
